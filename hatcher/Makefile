CXX=	g++
EMXX=	em++
ARXX=	ar rc
EMARXX=	emar rc
MKDIR=	mkdir
RM=	rm -f
RMDIR=	rm -fd

JS_DIR=			js/
SRCS_DIR=		srcs/hatcher/
INC_DIR=		srcs/
OBJS_DIR=		objs/
BIN_DIR=		bin/
NATIVE_DIR=		native/
WEBASM_DIR=		webasm/
RELEASE_DIR=		release/
DEBUG_DIR=		debug/

SRCS_SUBDIRS=		Graphics/	\

SRCS_SUBSUBDIRS=	Graphics/Core/	\

OBJS_NATIVE_DIR=		$(OBJS_DIR)$(NATIVE_DIR)
OBJS_NATIVE_RELEASE_DIR=	$(OBJS_NATIVE_DIR)$(RELEASE_DIR)
OBJS_NATIVE_RELEASE_SUBDIRS=	$(SRCS_SUBDIRS:%=$(OBJS_NATIVE_RELEASE_DIR)%)
OBJS_NATIVE_RELEASE_SUBSUBDIRS=	$(SRCS_SUBSUBDIRS:%=$(OBJS_NATIVE_RELEASE_DIR)%)
OBJS_NATIVE_DEBUG_DIR=		$(OBJS_NATIVE_DIR)$(DEBUG_DIR)
OBJS_NATIVE_DEBUG_SUBDIRS=	$(SRCS_SUBDIRS:%=$(OBJS_NATIVE_DEBUG_DIR)%)
OBJS_NATIVE_DEBUG_SUBSUBDIRS=	$(SRCS_SUBSUBDIRS:%=$(OBJS_NATIVE_DEBUG_DIR)%)
OBJS_WEBASM_DIR=		$(OBJS_DIR)$(WEBASM_DIR)
OBJS_WEBASM_RELEASE_DIR=	$(OBJS_WEBASM_DIR)$(RELEASE_DIR)
OBJS_WEBASM_RELEASE_SUBDIRS=	$(SRCS_SUBDIRS:%=$(OBJS_WEBASM_RELEASE_DIR)%)
OBJS_WEBASM_RELEASE_SUBSUBDIRS=	$(SRCS_SUBSUBDIRS:%=$(OBJS_WEBASM_RELEASE_DIR)%)
OBJS_WEBASM_DEBUG_DIR=		$(OBJS_WEBASM_DIR)$(DEBUG_DIR)
OBJS_WEBASM_DEBUG_SUBDIRS=	$(SRCS_SUBDIRS:%=$(OBJS_WEBASM_DEBUG_DIR)%)
OBJS_WEBASM_DEBUG_SUBSUBDIRS=	$(SRCS_SUBSUBDIRS:%=$(OBJS_WEBASM_DEBUG_DIR)%)
WEBASM_BIN_DIR=			$(BIN_DIR)

# Order matters here : subfolders must be on top of their root folder, because it is the order used to delete them.
OBJS_DIRS=		$(OBJS_NATIVE_RELEASE_SUBSUBDIRS)	\
			$(OBJS_NATIVE_RELEASE_SUBDIRS)		\
			$(OBJS_NATIVE_RELEASE_DIR)		\
			$(OBJS_NATIVE_DEBUG_SUBSUBDIRS)		\
			$(OBJS_NATIVE_DEBUG_SUBDIRS)		\
			$(OBJS_NATIVE_DEBUG_DIR)		\
			$(OBJS_NATIVE_DIR)			\
			$(OBJS_WEBASM_RELEASE_SUBSUBDIRS)	\
			$(OBJS_WEBASM_RELEASE_SUBDIRS)		\
			$(OBJS_WEBASM_RELEASE_DIR)		\
			$(OBJS_WEBASM_DEBUG_SUBSUBDIRS)		\
			$(OBJS_WEBASM_DEBUG_SUBDIRS)		\
			$(OBJS_WEBASM_DEBUG_DIR)		\
			$(OBJS_WEBASM_DIR)			\
			$(OBJS_DIR)				\

CXX_COMMON_FLAGS=	-Wall -Werror		\
			-std=c++17		\
			-I $(INC_DIR)		\

CXX_RELEASE_FLAGS=	$(CXX_COMMON_FLAGS)	\
			-O3

CXX_DEBUG_FLAGS=	$(CXX_COMMON_FLAGS)	\
			-g3			\
			-DNDEBUG		\

CXX_NATIVE_FLAGS=

EMXX_FLAGS=		-s WASM=1 -s USE_PTHREADS=1	\
			-Wno-deprecated-volatile	\

LD_NATIVE_RELEASE_FLAGS=

LD_NATIVE_DEBUG_FLAGS=

LD_WEBASM_RELEASE_FLAGS=

LD_WEBASM_DEBUG_FLAGS=


SRCS_FILES=	ComponentManager.cpp			\
		EntityManager.cpp			\
		EntityIDRegistry.cpp	    		\
		GameApplication.cpp 			\
		World.cpp				\
							\
		Graphics/Core/GLContext.cpp		\
		Graphics/Core/ShaderProgram.cpp		\
		Graphics/Core/VertexArrayObject.cpp	\
		Graphics/Core/VertexBufferObject.cpp	\
		Graphics/Core/Window.cpp 		\
		Graphics/AbstractEventUpdater.cpp	\
		Graphics/Clock.cpp			\
		Graphics/FrameRenderer.cpp		\
		Graphics/Material.cpp 			\
		Graphics/MaterialFactory.cpp		\
		Graphics/Mesh.cpp 			\
		Graphics/MeshBuilder.cpp		\
		Graphics/Rendering.cpp 			\
		Graphics/Texture.cpp 			\
		
SRCS=   	$(addprefix $(SRCS_DIR),$(SRCS_FILES))

LIB_NAME=	libhatcher

OBJS_NATIVE_RELEASE=	$(SRCS:$(SRCS_DIR)%.cpp=$(OBJS_NATIVE_RELEASE_DIR)%.o)
OBJS_NATIVE_DEBUG=	$(SRCS:$(SRCS_DIR)%.cpp=$(OBJS_NATIVE_DEBUG_DIR)%.o)
OBJS_WEBASM_RELEASE=	$(SRCS:$(SRCS_DIR)%.cpp=$(OBJS_WEBASM_RELEASE_DIR)%.o)
OBJS_WEBASM_DEBUG=	$(SRCS:$(SRCS_DIR)%.cpp=$(OBJS_WEBASM_DEBUG_DIR)%.o)
OBJS=			$(OBJS_NATIVE_RELEASE)	\
			$(OBJS_NATIVE_DEBUG)	\
			$(OBJS_WEBASM_RELEASE)	\
			$(OBJS_WEBASM_DEBUG)	\

DEPS=			$(OBJS:.o=.dep)

BIN_NATIVE_RELEASE=	$(BIN_DIR)$(LIB_NAME)_release.a

BIN_NATIVE_DEBUG=	$(BIN_DIR)$(LIB_NAME)_debug.a

BIN_WEBASM_RELEASE=	$(BIN_DIR)$(LIB_NAME)_webasm_release.a

BIN_WEBASM_DEBUG=	$(BIN_DIR)$(LIB_NAME)_webasm_debug.a

BINS=			$(BIN_NATIVE_RELEASE)	\
			$(BIN_NATIVE_DEBUG)	\
			$(BIN_WEBASM_RELEASE)	\
			$(BIN_WEBASM_DEBUG)	\


.SECONDARY:

include $(shell test -d $(OBJS_DIR) && find $(OBJS_DIR) -name "*.dep")

$(OBJS_DIR):
	$(MKDIR) $@

$(OBJS_NATIVE_DIR):		| $(OBJS_DIR)
	$(MKDIR) $@

$(OBJS_NATIVE_RELEASE_DIR):	| $(OBJS_NATIVE_DIR)
	$(MKDIR) $@

$(OBJS_NATIVE_RELEASE_DIR)%/:	| $(OBJS_NATIVE_RELEASE_DIR)
	$(MKDIR) $@

$(OBJS_NATIVE_DEBUG_DIR):	| $(OBJS_NATIVE_DIR)
	$(MKDIR) $@

$(OBJS_NATIVE_DEBUG_DIR)%/:	| $(OBJS_NATIVE_DEBUG_DIR)
	$(MKDIR) $@

$(OBJS_NATIVE_RELEASE_DIR)%.o:	$(SRCS_DIR)%.cpp | $(OBJS_NATIVE_RELEASE_DIR) $(OBJS_NATIVE_RELEASE_SUBDIRS) $(OBJS_NATIVE_RELEASE_SUBSUBDIRS)
	$(CXX) $(CXX_NATIVE_FLAGS) $(CXX_RELEASE_FLAGS) -MMD -MF $(@:.o=.dep) -c $< -o $@

$(OBJS_NATIVE_DEBUG_DIR)%.o:	$(SRCS_DIR)%.cpp | $(OBJS_NATIVE_DEBUG_DIR) $(OBJS_NATIVE_DEBUG_SUBDIRS) $(OBJS_NATIVE_DEBUG_SUBSUBDIRS)
	$(CXX) $(CXX_NATIVE_FLAGS) $(CXX_DEBUG_FLAGS) -MMD -MF $(@:.o=.dep) -c $< -o $@

$(OBJS_WEBASM_DIR):		| $(OBJS_DIR)
	$(MKDIR) $@

$(OBJS_WEBASM_RELEASE_DIR):	| $(OBJS_WEBASM_DIR)
	$(MKDIR) $@

$(OBJS_WEBASM_RELEASE_DIR)%/:	| $(OBJS_WEBASM_RELEASE_DIR)
	$(MKDIR) $@

$(OBJS_WEBASM_DEBUG_DIR):	| $(OBJS_WEBASM_DIR)
	$(MKDIR) $@

$(OBJS_WEBASM_DEBUG_DIR)%/:	| $(OBJS_WEBASM_DEBUG_DIR)
	$(MKDIR) $@

$(OBJS_WEBASM_RELEASE_DIR)%.o:	$(SRCS_DIR)%.cpp | $(OBJS_WEBASM_RELEASE_DIR) $(OBJS_WEBASM_RELEASE_SUBDIRS) $(OBJS_WEBASM_RELEASE_SUBSUBDIRS)
	$(EMXX) $(EMXX_FLAGS) $(CXX_RELEASE_FLAGS) -MMD -MF $(@:.o=.dep) -c $< -o $@

$(OBJS_WEBASM_DEBUG_DIR)%.o:	$(SRCS_DIR)%.cpp | $(OBJS_WEBASM_DEBUG_DIR) $(OBJS_WEBASM_DEBUG_SUBDIRS) $(OBJS_WEBASM_DEBUG_SUBSUBDIRS)
	$(EMXX) $(EMXX_FLAGS) $(CXX_DEBUG_FLAGS) -MMD -MF $(@:.o=.dep) -c $< -o $@


$(BIN_DIR):
	$(MKDIR) $@

$(BIN_NATIVE_RELEASE):	$(OBJS_NATIVE_RELEASE) | $(BIN_DIR)
	$(ARXX) $(BIN_NATIVE_RELEASE) $(OBJS_NATIVE_RELEASE) $(LD_NATIVE_RELEASE_FLAGS)

$(BIN_NATIVE_DEBUG):	$(OBJS_NATIVE_DEBUG) | $(BIN_DIR)
	$(ARXX) $(BIN_NATIVE_DEBUG) $(OBJS_NATIVE_DEBUG) $(LD_NATIVE_DEBUG_FLAGS)

$(BIN_WEBASM_RELEASE):	$(OBJS_WEBASM_RELEASE) | $(WEBASM_BIN_DIR)
	$(EMARXX) $(BIN_WEBASM_RELEASE) $(OBJS_WEBASM_RELEASE) $(LD_WEBASM_RELEASE_FLAGS)

$(BIN_WEBASM_DEBUG):	$(OBJS_WEBASM_DEBUG) | $(WEBASM_BIN_DIR)
	$(EMARXX) $(BIN_WEBASM_DEBUG) $(OBJS_WEBASM_DEBUG) $(LD_WEBASM_DEBUG_FLAGS)


all:	$(BINS)

clean:
	$(RM) $(OBJS) $(DEPS)
	$(RMDIR) $(OBJS_DIRS)

fclean: clean
	$(RM) $(BINS)
	$(RMDIR) $(BIN_DIR)

re:	fclean native_release

# aliases command
native_release:	$(BIN_NATIVE_RELEASE)
native_debug:	$(BIN_NATIVE_DEBUG)
webasm_release:	$(BIN_WEBASM_RELEASE)
webasm_debug:	$(BIN_WEBASM_DEBUG)

.DEFAULT_GOAL=	native_release
